<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annual Sports Day 2K25 - Registration Portal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* Additional styles for OTP section */
        .otp-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideIn 0.5s ease;
            display: none;
        }
        
        .otp-section.show {
            display: block;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .otp-title {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2rem;
        }
        
        .otp-timer {
            text-align: center;
            color: #ff6b6b;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .otp-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .btn-success.verified {
            animation: pulse 2s infinite;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%) !important;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .message.success {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
            color: #2ecc71;
        }
        
        .message.error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
            color: #e74c3c;
        }
        
        .message.info {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid #3498db;
            color: #3498db;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-trophy"></i>
                    <h1>Annual <span>Sports Day 2K25</span></h1>
                </div>
                <div class="nav-buttons">
                    <button class="btn btn-primary" id="registerBtn">
                        <i class="fas fa-user-plus"></i> Register
                    </button>
                    <button class="btn btn-outline" id="deleteBtn">
                        <i class="fas fa-user-minus"></i> Delete Registration
                    </button>
                    <button class="btn btn-warning" id="adminBtn" onclick="window.location.href='/admin-login.html'">
                        <i class="fas fa-lock"></i> Admin Panel
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Registration Form -->
        <section id="registerSection" class="section active">
            <h2 class="section-title">Sports Registration Form</h2>
            
            <div id="registerMessage" class="message"></div>
            
            <form id="registrationForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="name" class="required">Full Name</label>
                        <input type="text" id="name" name="name" required placeholder="Enter your full name">
                    </div>
                    <div class="form-group">
                        <label for="rollNo" class="required">Roll Number</label>
                        <input type="text" id="rollNo" name="rollNo" required placeholder="Enter your roll number">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="phone" class="required">Phone Number</label>
                        <input type="tel" id="phone" name="phone" required placeholder="Enter 10-digit phone number">
                    </div>
                    <div class="form-group">
                        <label for="email" class="required">Email Address</label>
                        <input type="email" id="email" name="email" required placeholder="Enter your email address">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="department" class="required">Department</label>
                        <select id="department" name="department" required>
                            <option value="">Select Department</option>
                            <option value="AIML">Artificial Intelligence & Machine Learning</option>
                            <option value="ENTC">Electronics & Telecommunication</option>
                            <option value="CS">Computer Science</option>
                            <option value="COMPUTER">Computer Engineering</option>
                            <option value="Mechanical">Mechanical Engineering</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="batch" class="required">Batch</label>
                        <input type="text" id="batch" name="batch" required placeholder="e.g. 2021-2025">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="year" class="required">Year</label>
                        <select id="year" name="year" required>
                            <option value="">Select Year</option>
                            <option value="1">First Year</option>
                            <option value="2">Second Year</option>
                            <option value="3">Third Year</option>
                            <option value="4">Fourth Year</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="gender" class="required">Gender</label>
                        <select id="gender" name="gender" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="required">Select Sports</label>
                    <div class="sports-options">
                        <label class="sport-checkbox">
                            <input type="checkbox" name="sports" value="Cricket">
                            <i class="fas fa-baseball-ball"></i>
                            <span>Cricket</span>
                        </label>
                        <label class="sport-checkbox">
                            <input type="checkbox" name="sports" value="Badminton">
                            <i class="fas fa-table-tennis"></i>
                            <span>Badminton</span>
                        </label>
                        <label class="sport-checkbox">
                            <input type="checkbox" name="sports" value="Carom">
                            <i class="fas fa-gamepad"></i>
                            <span>Carom</span>
                        </label>
                        <label class="sport-checkbox">
                            <input type="checkbox" name="sports" value="Chess">
                            <i class="fas fa-chess"></i>
                            <span>Chess</span>
                        </label>
                        <label class="sport-checkbox">
                            <input type="checkbox" name="sports" value="Running">
                            <i class="fas fa-running"></i>
                            <span>Running</span>
                        </label>
                        <label class="sport-checkbox">
                            <input type="checkbox" name="sports" value="Kho-Kho">
                            <i class="fas fa-people-arrows"></i>
                            <span>Kho-Kho</span>
                        </label>
                        <label class="sport-checkbox">
                            <input type="checkbox" name="sports" value="Kabaddi">
                            <i class="fas fa-users"></i>
                            <span>Kabaddi</span>
                        </label>
                        <label class="sport-checkbox">
                            <input type="checkbox" name="sports" value="Volleyball">
                            <i class="fas fa-volleyball-ball"></i>
                            <span>Volleyball</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <button type="button" id="requestOtpBtn" class="btn btn-warning" onclick="requestRegistrationOTP()">
                        <i class="fas fa-key"></i> Request OTP
                    </button>
                </div>
                
                <!-- Registration OTP Section -->
                <div id="registrationOtpSection" class="otp-section">
                    <div class="otp-title">
                        <i class="fas fa-shield-alt"></i> Enter 6-digit OTP sent to your email/phone
                    </div>
                    
                    <div class="form-group">
                        <div class="otp-inputs">
                            <input type="text" maxlength="1" class="otp-input" id="regOtp1" data-index="1">
                            <input type="text" maxlength="1" class="otp-input" id="regOtp2" data-index="2">
                            <input type="text" maxlength="1" class="otp-input" id="regOtp3" data-index="3">
                            <input type="text" maxlength="1" class="otp-input" id="regOtp4" data-index="4">
                            <input type="text" maxlength="1" class="otp-input" id="regOtp5" data-index="5">
                            <input type="text" maxlength="1" class="otp-input" id="regOtp6" data-index="6">
                        </div>
                    </div>
                    
                    <div id="registrationOtpTimer" class="otp-timer">
                        <i class="fas fa-clock"></i> Time remaining: <span id="registrationTimerValue">10:00</span>
                    </div>
                    
                    <div class="otp-actions">
                        <button type="button" id="verifyRegistrationOtpBtn" class="btn btn-success" onclick="verifyRegistrationOTP()">
                            <i class="fas fa-check"></i> Verify OTP
                        </button>
                        <button type="button" id="resendRegistrationOtpBtn" class="btn btn-outline" onclick="requestRegistrationOTP()">
                            <i class="fas fa-redo"></i> Resend OTP
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <button type="submit" id="submitRegistration" class="btn btn-success" style="width: 100%; padding: 15px;" disabled>
                        <i class="fas fa-paper-plane"></i> Submit Registration
                    </button>
                </div>
            </form>
        </section>

        <!-- Delete Registration -->
        <section id="deleteSection" class="section">
            <h2 class="section-title">Delete Your Registration</h2>
            
            <div id="deleteMessage" class="message"></div>
            
            <form id="deleteForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="deleteRollNo" class="required">Roll Number</label>
                        <input type="text" id="deleteRollNo" name="deleteRollNo" required placeholder="Enter your roll number">
                    </div>
                    <div class="form-group">
                        <label for="deleteEmail" class="required">Email Address</label>
                        <input type="email" id="deleteEmail" name="deleteEmail" required placeholder="Enter your registered email">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="deletePhone" class="required">Phone Number</label>
                    <input type="tel" id="deletePhone" name="deletePhone" required placeholder="Enter your registered phone number">
                </div>
                
                <div class="form-group">
                    <button type="button" id="requestDeleteOtpBtn" class="btn btn-warning" onclick="requestDeletionOTP()">
                        <i class="fas fa-key"></i> Request OTP for Deletion
                    </button>
                </div>
                
                <!-- Deletion OTP Section -->
                <div id="deletionOtpSection" class="otp-section">
                    <div class="otp-title">
                        <i class="fas fa-shield-alt"></i> Enter 6-digit OTP sent to your email/phone
                    </div>
                    
                    <div class="form-group">
                        <div class="otp-inputs">
                            <input type="text" maxlength="1" class="otp-input" id="delOtp1" data-index="1">
                            <input type="text" maxlength="1" class="otp-input" id="delOtp2" data-index="2">
                            <input type="text" maxlength="1" class="otp-input" id="delOtp3" data-index="3">
                            <input type="text" maxlength="1" class="otp-input" id="delOtp4" data-index="4">
                            <input type="text" maxlength="1" class="otp-input" id="delOtp5" data-index="5">
                            <input type="text" maxlength="1" class="otp-input" id="delOtp6" data-index="6">
                        </div>
                    </div>
                    
                    <div id="deletionOtpTimer" class="otp-timer">
                        <i class="fas fa-clock"></i> Time remaining: <span id="deletionTimerValue">10:00</span>
                    </div>
                    
                    <div class="otp-actions">
                        <button type="button" id="verifyDeletionOtpBtn" class="btn btn-danger" onclick="verifyDeletionOTP()">
                            <i class="fas fa-trash-alt"></i> Verify & Delete
                        </button>
                        <button type="button" id="resendDeletionOtpBtn" class="btn btn-outline" onclick="requestDeletionOTP()">
                            <i class="fas fa-redo"></i> Resend OTP
                        </button>
                    </div>
                </div>
            </form>
        </section>

        <!-- Admin Panel -->
        <section id="adminSection" class="section">
            <h2 class="section-title">Admin Panel - Participants Management</h2>
            
            <div id="adminMessage" class="message"></div>
            
            <div class="admin-controls">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search by name, roll number, email, department, sports...">
                </div>
                
                <div class="filters">
                    <div class="filter-group">
                        <label>Filter by:</label>
                        <select id="filterDepartment">
                            <option value="">All Departments</option>
                            <option value="AIML">AIML</option>
                            <option value="ENTC">ENTC</option>
                            <option value="CS">CS</option>
                            <option value="COMPUTER">COMPUTER</option>
                            <option value="Mechanical">Mechanical</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <select id="filterSport">
                            <option value="">All Sports</option>
                            <option value="Cricket">Cricket</option>
                            <option value="Badminton">Badminton</option>
                            <option value="Carom">Carom</option>
                            <option value="Chess">Chess</option>
                            <option value="Running">Running</option>
                            <option value="Kho-Kho">Kho-Kho</option>
                            <option value="Kabaddi">Kabaddi</option>
                            <option value="Volleyball">Volleyball</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <select id="filterGender">
                            <option value="">All Genders</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <button id="resetFilters" class="btn btn-outline">
                        <i class="fas fa-redo"></i> Reset Filters
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <table id="participantsTable">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Roll No</th>
                            <th>Department</th>
                            <th>Batch</th>
                            <th>Year</th>
                            <th>Gender</th>
                            <th>Sports</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="participantsBody">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
                
                <div id="noDataMessage" class="no-data">
                    <i class="fas fa-users-slash"></i>
                    <h3>No Participants Found</h3>
                    <p>Register participants to see them listed here.</p>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <p>&copy; 2025 Annual Sports Day 2K25. All rights reserved.</p>
                <div class="footer-links">
                    <a href="#"><i class="fas fa-question-circle"></i> Help</a>
                    <a href="#"><i class="fas fa-envelope"></i> Contact</a>
                    <a href="#"><i class="fas fa-shield-alt"></i> Privacy Policy</a>
                </div>
                <p>Designed for all devices | Responsive Web Portal</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Store OTP IDs and timers
            let currentOtpId = null;
            let currentOtpType = null; // 'registration' or 'deletion'
            let otpVerified = false;
            let otpTimer = null;
            let timeLeft = 600; // 10 minutes in seconds

            // Navigation
            document.getElementById('registerBtn').addEventListener('click', () => {
                setActiveSection('registerSection');
                updateButtonStates('registerBtn');
                resetRegistrationForm();
            });

            document.getElementById('deleteBtn').addEventListener('click', () => {
                setActiveSection('deleteSection');
                updateButtonStates('deleteBtn');
                resetDeletionForm();
            });

            document.getElementById('adminBtn').addEventListener('click', () => {
                setActiveSection('adminSection');
                updateButtonStates('adminBtn');
                loadParticipants();
            });

            function setActiveSection(sectionId) {
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(sectionId).classList.add('active');
                clearMessages();
            }

            function updateButtonStates(activeButtonId) {
                const buttons = ['registerBtn', 'deleteBtn', 'adminBtn'];
                buttons.forEach(buttonId => {
                    const btn = document.getElementById(buttonId);
                    if (buttonId === activeButtonId) {
                        btn.classList.add('btn-primary');
                        btn.classList.remove('btn-outline');
                        if (buttonId === 'adminBtn') btn.classList.remove('btn-warning');
                    } else {
                        btn.classList.remove('btn-primary');
                        if (buttonId !== 'adminBtn') btn.classList.add('btn-outline');
                    }
                });
            }

            function clearMessages() {
                document.querySelectorAll('.message').forEach(msg => {
                    msg.style.display = 'none';
                    msg.textContent = '';
                });
            }

            function showMessage(elementId, message, type = 'success') {
                const messageElement = document.getElementById(elementId);
                messageElement.textContent = message;
                messageElement.style.display = 'block';
                messageElement.className = `message ${type}`;
                
                if (type === 'success') {
                    setTimeout(() => {
                        messageElement.style.display = 'none';
                    }, 5000);
                }
            }

            // Setup OTP Inputs
            function setupOTPInputs(sectionPrefix) {
                const inputs = document.querySelectorAll(`#${sectionPrefix}OtpSection .otp-input`);
                
                inputs.forEach((input, index) => {
                    input.addEventListener('input', (e) => {
                        const value = e.target.value;
                        // Only allow numbers
                        if (!/^\d*$/.test(value)) {
                            e.target.value = value.replace(/\D/g, '');
                            return;
                        }
                        
                        // Move to next input
                        if (value.length === 1 && index < inputs.length - 1) {
                            inputs[index + 1].focus();
                        }
                        
                        // Auto-verify when all inputs are filled
                        if (index === inputs.length - 1 && value.length === 1) {
                            const allFilled = Array.from(inputs).every(input => input.value.length === 1);
                            if (allFilled) {
                                setTimeout(() => {
                                    if (sectionPrefix === 'registration') {
                                        verifyRegistrationOTP();
                                    } else if (sectionPrefix === 'deletion') {
                                        verifyDeletionOTP();
                                    }
                                }, 300);
                            }
                        }
                    });
                    
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Backspace' && !e.target.value && index > 0) {
                            inputs[index - 1].focus();
                        }
                    });
                });
            }

            // Initialize OTP inputs
            setupOTPInputs('registration');
            setupOTPInputs('deletion');

            // Get OTP from input fields
            function getOTPFromInputs(sectionPrefix) {
                const inputs = document.querySelectorAll(`#${sectionPrefix}OtpSection .otp-input`);
                return Array.from(inputs).map(input => input.value).join('');
            }

            // Clear OTP fields
            function clearOTPFields(sectionPrefix) {
                document.querySelectorAll(`#${sectionPrefix}OtpSection .otp-input`).forEach(input => {
                    input.value = '';
                });
            }

            // Focus first OTP input
            function focusFirstOTPInput(sectionPrefix) {
                const firstInput = document.querySelector(`#${sectionPrefix}OtpSection .otp-input`);
                if (firstInput) {
                    firstInput.focus();
                }
            }

            // Show OTP section
            function showOTPSection(sectionPrefix) {
                const otpSection = document.getElementById(`${sectionPrefix}OtpSection`);
                if (otpSection) {
                    otpSection.classList.add('show');
                    setTimeout(() => {
                        focusFirstOTPInput(sectionPrefix);
                    }, 100);
                    
                    // Start timer
                    startOTPTimer(sectionPrefix);
                }
            }

            // Hide OTP section
            function hideOTPSection(sectionPrefix) {
                const otpSection = document.getElementById(`${sectionPrefix}OtpSection`);
                if (otpSection) {
                    otpSection.classList.remove('show');
                }
            }

            // Start OTP timer
            function startOTPTimer(sectionPrefix) {
                timeLeft = 600; // 10 minutes
                const timerElement = sectionPrefix === 'registration' ? 
                    document.getElementById('registrationTimerValue') : 
                    document.getElementById('deletionTimerValue');
                const timerContainer = sectionPrefix === 'registration' ?
                    document.getElementById('registrationOtpTimer') :
                    document.getElementById('deletionOtpTimer');
                    
                timerContainer.style.display = 'block';
                
                if (otpTimer) {
                    clearInterval(otpTimer);
                }
                
                otpTimer = setInterval(() => {
                    timeLeft--;
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    if (timeLeft <= 0) {
                        clearInterval(otpTimer);
                        timerElement.textContent = '00:00';
                        showMessage(
                            sectionPrefix === 'registration' ? 'registerMessage' : 'deleteMessage',
                            'OTP expired. Please request a new one.',
                            'error'
                        );
                        hideOTPSection(sectionPrefix);
                        currentOtpId = null;
                        otpVerified = false;
                    }
                }, 1000);
            }

            // Reset registration form
            function resetRegistrationForm() {
                document.getElementById('submitRegistration').disabled = true;
                document.getElementById('submitRegistration').classList.remove('verified');
                hideOTPSection('registration');
                clearOTPFields('registration');
                currentOtpId = null;
                otpVerified = false;
                if (otpTimer) {
                    clearInterval(otpTimer);
                }
            }

            // Reset deletion form
            function resetDeletionForm() {
                hideOTPSection('deletion');
                clearOTPFields('deletion');
                currentOtpId = null;
                otpVerified = false;
                if (otpTimer) {
                    clearInterval(otpTimer);
                }
            }

            // API Functions
            async function apiRequest(endpoint, method = 'GET', data = null) {
                try {
                    const options = {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    };

                    if (data) {
                        options.body = JSON.stringify(data);
                    }

                    const response = await fetch(`/api${endpoint}`, options);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    
                    return await response.json();
                    
                } catch (error) {
                    console.error('API request failed:', error);
                    throw error;
                }
            }

            // Registration OTP Request
            window.requestRegistrationOTP = async function() {
                const name = document.getElementById('name').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const email = document.getElementById('email').value.trim();
                
                // Validation
                if (!name) {
                    showMessage('registerMessage', 'Please enter your name', 'error');
                    return;
                }
                
                if (!/^\d{10}$/.test(phone)) {
                    showMessage('registerMessage', 'Please enter a valid 10-digit phone number', 'error');
                    return;
                }

                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showMessage('registerMessage', 'Please enter a valid email address', 'error');
                    return;
                }

                showMessage('registerMessage', 'üì® Sending OTP to your email and phone...', 'info');

                try {
                    const result = await apiRequest('/otp/request-registration-otp', 'POST', {
                        name,
                        email,
                        phone
                    });

                    if (result.success) {
                        currentOtpId = result.otpId;
                        currentOtpType = 'registration';
                        otpVerified = false;
                        
                        // Show OTP section
                        showOTPSection('registration');
                        
                        let message = 'üìß OTP has been sent to your email';
                        if (result.demoMode) {
                            message = 'üîß Demo Mode: Check server console for OTP';
                        }
                        
                        showMessage('registerMessage', message, 'success');
                        
                        // Enable verification button
                        document.getElementById('verifyRegistrationOtpBtn').disabled = false;
                        
                    } else {
                        showMessage('registerMessage', result.message || 'Failed to send OTP', 'error');
                    }
                    
                } catch (error) {
                    showMessage('registerMessage', '‚ùå Failed to send OTP. Please try again.', 'error');
                }
            };

            // Verify Registration OTP
            window.verifyRegistrationOTP = async function() {
                const otp = getOTPFromInputs('registration');
                
                if (otp.length !== 6) {
                    showMessage('registerMessage', 'Please enter complete 6-digit OTP', 'error');
                    return;
                }

                if (!currentOtpId) {
                    showMessage('registerMessage', 'Please request OTP first', 'error');
                    return;
                }

                showMessage('registerMessage', 'üîê Verifying OTP...', 'info');

                try {
                    const result = await apiRequest('/otp/verify-otp', 'POST', {
                        otpId: currentOtpId,
                        otp: otp
                    });

                    if (result.success) {
                        otpVerified = true;
                        showMessage('registerMessage', '‚úÖ OTP verified successfully! You can now submit registration.', 'success');
                        document.getElementById('submitRegistration').disabled = false;
                        document.getElementById('submitRegistration').classList.add('verified');
                        if (otpTimer) {
                            clearInterval(otpTimer);
                        }
                    } else {
                        showMessage('registerMessage', `‚ùå ${result.message}`, 'error');
                        clearOTPFields('registration');
                        focusFirstOTPInput('registration');
                    }
                    
                } catch (error) {
                    showMessage('registerMessage', '‚ùå OTP verification failed', 'error');
                }
            };

            // Deletion OTP Request
            window.requestDeletionOTP = async function() {
                const rollNo = document.getElementById('deleteRollNo').value.trim();
                const email = document.getElementById('deleteEmail').value.trim();
                const phone = document.getElementById('deletePhone').value.trim();
                
                if (!rollNo || !email || !phone) {
                    showMessage('deleteMessage', 'Please fill all fields first', 'error');
                    return;
                }

                showMessage('deleteMessage', 'üì® Sending OTP...', 'info');

                try {
                    const result = await apiRequest('/otp/request-deletion-otp', 'POST', {
                        rollNo,
                        email,
                        phone
                    });

                    if (result.success) {
                        currentOtpId = result.otpId;
                        currentOtpType = 'deletion';
                        otpVerified = false;
                        
                        // Show OTP section
                        showOTPSection('deletion');
                        
                        let message = 'üìß OTP has been sent to your email';
                        if (result.demoMode) {
                            message = 'üîß Demo Mode: Check server console for OTP';
                        }
                        
                        showMessage('deleteMessage', message, 'success');
                        
                    } else {
                        showMessage('deleteMessage', result.message || 'Failed to send OTP', 'error');
                    }
                    
                } catch (error) {
                    showMessage('deleteMessage', '‚ùå Failed to send OTP. Please try again.', 'error');
                }
            };

            // Verify Deletion OTP
            window.verifyDeletionOTP = async function() {
                const otp = getOTPFromInputs('deletion');
                
                if (otp.length !== 6) {
                    showMessage('deleteMessage', 'Please enter complete 6-digit OTP', 'error');
                    return;
                }

                if (!currentOtpId) {
                    showMessage('deleteMessage', 'Please request OTP first', 'error');
                    return;
                }

                showMessage('deleteMessage', 'üîê Verifying OTP and deleting...', 'info');

                try {
                    // First verify OTP
                    const verifyResult = await apiRequest('/otp/verify-otp', 'POST', {
                        otpId: currentOtpId,
                        otp: otp
                    });

                    if (verifyResult.success) {
                        otpVerified = true;
                        
                        // Now delete the registration
                        const rollNo = document.getElementById('deleteRollNo').value.trim();
                        const deleteResult = await apiRequest('/participants/delete', 'POST', {
                            rollNo: rollNo
                        });

                        if (deleteResult.success) {
                            showMessage('deleteMessage', '‚úÖ Registration deleted successfully!', 'success');
                            document.getElementById('deleteForm').reset();
                            clearOTPFields('deletion');
                            hideOTPSection('deletion');
                            currentOtpId = null;
                            otpVerified = false;
                            if (otpTimer) {
                                clearInterval(otpTimer);
                            }
                            
                            // Update admin table
                            if (document.getElementById('adminSection').classList.contains('active')) {
                                loadParticipants();
                            }
                        } else {
                            showMessage('deleteMessage', `‚ùå ${deleteResult.message}`, 'error');
                        }
                        
                    } else {
                        showMessage('deleteMessage', `‚ùå ${verifyResult.message}`, 'error');
                        clearOTPFields('deletion');
                        focusFirstOTPInput('deletion');
                    }
                    
                } catch (error) {
                    showMessage('deleteMessage', '‚ùå Deletion failed. Please try again.', 'error');
                }
            };

            // Registration form submission
            document.getElementById('registrationForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Check if OTP is verified
                if (!otpVerified) {
                    showMessage('registerMessage', 'Please verify OTP first', 'error');
                    return;
                }

                const name = document.getElementById('name').value.trim();
                const rollNo = document.getElementById('rollNo').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const email = document.getElementById('email').value.trim();
                const department = document.getElementById('department').value;
                const batch = document.getElementById('batch').value.trim();
                const year = document.getElementById('year').value;
                const gender = document.getElementById('gender').value;
                
                // Get selected sports
                const sportsCheckboxes = document.querySelectorAll('input[name="sports"]:checked');
                const sports = Array.from(sportsCheckboxes).map(cb => cb.value);
                
                if (sports.length === 0) {
                    showMessage('registerMessage', 'Please select at least one sport!', 'error');
                    return;
                }
                
                // Additional validation
                if (!rollNo) {
                    showMessage('registerMessage', 'Roll number is required', 'error');
                    return;
                }

                if (!department) {
                    showMessage('registerMessage', 'Please select department', 'error');
                    return;
                }

                if (!batch.match(/^\d{4}-\d{4}$/)) {
                    showMessage('registerMessage', 'Batch format: YYYY-YYYY', 'error');
                    return;
                }

                if (!year) {
                    showMessage('registerMessage', 'Please select year', 'error');
                    return;
                }

                if (!gender) {
                    showMessage('registerMessage', 'Please select gender', 'error');
                    return;
                }

                showMessage('registerMessage', 'üìù Registering...', 'info');

                try {
                    // Submit registration
                    const registrationData = {
                        name,
                        rollNo,
                        phone,
                        email,
                        department,
                        batch,
                        year: parseInt(year),
                        gender,
                        sports
                    };

                    const result = await apiRequest('/participants/register', 'POST', registrationData);

                    if (result.success) {
                        showMessage('registerMessage', '‚úÖ Registration successful! You have been registered for the sports day.', 'success');
                        
                        // Reset form
                        this.reset();
                        hideOTPSection('registration');
                        clearOTPFields('registration');
                        document.getElementById('submitRegistration').disabled = true;
                        document.getElementById('submitRegistration').classList.remove('verified');
                        currentOtpId = null;
                        otpVerified = false;
                        
                        // Update admin table if visible
                        if (document.getElementById('adminSection').classList.contains('active')) {
                            loadParticipants();
                        }
                        
                    } else {
                        showMessage('registerMessage', `‚ùå ${result.message}`, 'error');
                    }
                    
                } catch (error) {
                    showMessage('registerMessage', '‚ùå Registration failed. Please try again.', 'error');
                }
            });

            // Load participants for admin panel
            async function loadParticipants() {
                try {
                    const result = await apiRequest('/participants/all');
                    
                    const tbody = document.getElementById('participantsBody');
                    const noDataMessage = document.getElementById('noDataMessage');
                    
                    tbody.innerHTML = '';
                    
                    if (!result.success || !result.data || result.data.length === 0) {
                        noDataMessage.style.display = 'flex';
                        return;
                    }
                    
                    noDataMessage.style.display = 'none';
                    
                    result.data.forEach((participant, index) => {
                        const row = document.createElement('tr');
                        
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${participant.name}</td>
                            <td>${participant.rollNo}</td>
                            <td>${participant.department}</td>
                            <td>${participant.batch}</td>
                            <td>Year ${participant.year}</td>
                            <td>${participant.gender}</td>
                            <td>${participant.sports.join(', ')}</td>
                            <td>${participant.email}</td>
                            <td>${participant.phone}</td>
                            <td>
                                <button class="btn-action delete-participant" data-roll="${participant.rollNo}" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                    
                    // Add event listeners to delete buttons
                    document.querySelectorAll('.delete-participant').forEach(button => {
                        button.addEventListener('click', function() {
                            const rollNo = this.getAttribute('data-roll');
                            if (confirm('Are you sure you want to delete this registration?')) {
                                deleteParticipant(rollNo);
                            }
                        });
                    });
                    
                    // Show count
                    showMessage('adminMessage', `üìä Showing ${result.data.length} participants`, 'info');
                    
                } catch (error) {
                    console.error('Failed to load participants:', error);
                    showMessage('adminMessage', '‚ùå Failed to load participants', 'error');
                }
            }

            async function deleteParticipant(rollNo) {
                try {
                    const result = await apiRequest('/participants/delete', 'POST', { rollNo });
                    
                    if (result.success) {
                        showMessage('adminMessage', '‚úÖ Participant deleted successfully!', 'success');
                        loadParticipants();
                    } else {
                        showMessage('adminMessage', `‚ùå ${result.message}`, 'error');
                    }
                    
                } catch (error) {
                    showMessage('adminMessage', '‚ùå Failed to delete participant', 'error');
                }
            }

            // Initialize the page
            setActiveSection('registerSection');
            updateButtonStates('registerBtn');
        });
    </script>
</body>
</html>